!function(){function e(e){for(var o=1;o<arguments.length;o++){var t=null!=arguments[o]?arguments[o]:{},a=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.forEach(function(o){var a;a=t[o],o in e?Object.defineProperty(e,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[o]=a})}return e}function o(e,o){return o=null!=o?o:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):(function(e,o){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t.push.apply(t,a)}return t})(Object(o)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}),e}function t(e,o){(null==o||o>e.length)&&(o=e.length);for(var t=0,a=Array(o);t<o;t++)a[t]=e[t];return a}var a=function(){"use strict";var a;function i(e){if(!(this instanceof i))throw TypeError("Cannot call a class as a function");this.bookmarks=[],this.STORAGE_KEY="bookmarks",this.standaloneWindow=e.standaloneWindow,this.overlay=e.overlay,this.sidebar=e.sidebar,this.event=e.event,this.console=e.console,this.menu=e.menu,this.core=e.core,this.preferences=e.preferences,this.iina=e.iina,this.loadBookmarks(),this.setupEventListeners(),this.setupWebUI(),this.setupUIMessageListeners(),this.console.log("IINA Bookmarks Plugin initialized. Message passing enabled.")}return a=[{key:"setupWebUI",value:function(){try{this.sidebar.loadFile("dist/ui/sidebar/index.html"),this.overlay.loadFile("dist/ui/overlay/index.html"),this.overlay.setClickable(!0),this.overlay.hide(),this.standaloneWindow.loadFile("dist/ui/window/index.html"),this.console.log("Web UIs loaded successfully.")}catch(e){this.console.error(`Error loading Web UIs: ${e.message}`)}}},{key:"setupUIMessageListeners",value:function(){var e=this,o=function(o){return function(t){if("string"==typeof t)try{a=JSON.parse(t)}catch(a){e.console.error(`[${o}] Error parsing JSON message:`,t,a);return}else{if("object"!=typeof t||null===t||!("type"in t))return void e.console.warn(`[${o}] Received non-standard message:`,t);a=t}switch(e.console.log(`[${o}] Received message:`,a),a.type){case"REQUEST_FILE_PATH":var a,i,r,s,n,l,d,c,u,h=e.core.status.path;("overlay"===o?e.overlay:"sidebar"===o?e.sidebar:e.standaloneWindow).postMessage(JSON.stringify({type:"CURRENT_FILE_PATH",data:h}));break;case"JUMP_TO_BOOKMARK":(null==(i=a.payload)?void 0:i.id)&&e.jumpToBookmark(a.payload.id);break;case"HIDE_OVERLAY":e.overlay.hide();break;case"ADD_BOOKMARK":e.addBookmark(null==(r=a.payload)?void 0:r.title,null==(s=a.payload)?void 0:s.timestamp,null==(n=a.payload)?void 0:n.description,null==(l=a.payload)?void 0:l.tags);break;case"DELETE_BOOKMARK":(null==(d=a.payload)?void 0:d.id)&&e.removeBookmark(a.payload.id);break;case"UPDATE_BOOKMARK":(null==(c=a.payload)?void 0:c.id)&&(null==(u=a.payload)?void 0:u.data)&&e.updateBookmark(a.payload.id,a.payload.data);break;case"UI_READY":var k="overlay"===o?e.overlay:"sidebar"===o?e.sidebar:e.standaloneWindow,m=e.getBookmarks(e.core.status.path||void 0);k.postMessage(JSON.stringify({type:"BOOKMARKS_UPDATED",data:m})),e.console.log(`Sent initial bookmarks to ${o} for path: ${e.core.status.path}`);break;default:e.console.warn(`[${o}] Unknown message type:`,a.type)}}};this.sidebar.onMessage(o("sidebar")),this.overlay.onMessage(o("overlay")),this.standaloneWindow.onMessage(o("window")),this.console.log("UI Message Listeners are set up.")}},{key:"loadBookmarks",value:function(){try{var t=this.preferences.get(this.STORAGE_KEY);if(t){var a=JSON.parse(t);this.bookmarks=a.map(function(t){return o(e({},t),{createdAt:t.createdAt?new Date(t.createdAt).toISOString():new Date().toISOString()})})}this.console.log("Bookmarks loaded:",this.bookmarks.length)}catch(e){this.console.error("Error loading bookmarks:",e.message),this.bookmarks=[]}}},{key:"saveBookmarks",value:function(){try{this.preferences.set(this.STORAGE_KEY,JSON.stringify(this.bookmarks)),this.console.log("Bookmarks saved."),this.refreshUIs()}catch(e){this.console.error("Error saving bookmarks:",e.message)}}},{key:"refreshUIs",value:function(e){var o=this.core.status.path,t=this.getBookmarks(o||void 0),a=JSON.stringify({type:"BOOKMARKS_UPDATED",data:t});this.console.log(`Refreshing UIs. Specific: ${e||"all"}. Path: ${o}. Count: ${t.length}`);try{e&&"sidebar"!==e||this.sidebar.postMessage(a),e&&"overlay"!==e||this.overlay.postMessage(a),e&&"window"!==e||this.standaloneWindow.postMessage(a)}catch(e){this.console.warn("Could not refresh one or more UIs. They might not be loaded yet.",e.message)}}},{key:"setupEventListeners",value:function(){var e=this;this.event.on("file-loaded",function(){e.console.log("File loaded event triggered."),e.refreshUIs()}),this.menu.addItem(this.menu.item("Add Bookmark at Current Time",function(){e.addBookmark()})),this.menu.addItem(this.menu.item("Manage Bookmarks",function(){e.standaloneWindow.show()})),this.menu.addItem(this.menu.item("Toggle Bookmarks Overlay",function(){e.overlay.isVisible()?e.overlay.hide():(e.refreshUIs("overlay"),e.overlay.show())}))}},{key:"addBookmark",value:function(e,o,t,a){var i=this.core.status.path,r=this.core.status.title||"Unknown Media",s=null!=o?o:this.core.status.position;if(!i){this.console.log("Cannot add bookmark: No file loaded."),this.iina.postMessage("showNotification",{title:"Error",message:"No file loaded to add a bookmark.",type:"error"});return}var n=e||`Bookmark at ${this.formatTime(s||0)} (${r})`,l={id:Date.now().toString(),title:n,timestamp:s||0,filepath:i,description:t||`Recorded on ${new Date().toLocaleDateString()}`,createdAt:new Date().toISOString(),tags:a||[]};this.bookmarks.push(l),this.saveBookmarks(),this.console.log("Bookmark added:",l.title),this.iina.postMessage("showNotification",{title:"Bookmark Added",message:l.title})}},{key:"removeBookmark",value:function(e){this.bookmarks=this.bookmarks.filter(function(o){return o.id!==e}),this.saveBookmarks(),this.console.log("Bookmark removed:",e),this.iina.postMessage("showNotification",{title:"Bookmark Removed"})}},{key:"updateBookmark",value:function(t,a){var i=this.bookmarks.findIndex(function(e){return e.id===t});if(-1!==i){var r=this.bookmarks[i];this.bookmarks[i]=o(e({},r,a),{id:r.id,filepath:r.filepath}),this.saveBookmarks(),this.console.log("Bookmark updated:",t),this.iina.postMessage("showNotification",{title:"Bookmark Updated"})}else this.console.log("Update failed: Bookmark not found",t)}},{key:"jumpToBookmark",value:function(e){var o=this,t=this.bookmarks.find(function(o){return o.id===e});t?(this.core.status.path!==t.filepath?(this.core.open(t.filepath),this.event.once("file-loaded",function(){o.core.seek(t.timestamp),o.refreshUIs("overlay"),o.overlay.show()})):(this.core.seek(t.timestamp),this.refreshUIs("overlay"),this.overlay.show()),this.console.log("Jumped to bookmark:",t.title),this.standaloneWindow.hide()):this.console.log("Jump failed: Bookmark not found",e)}},{key:"getBookmarks",value:function(e){var o,a=this.bookmarks;return e&&(a=this.bookmarks.filter(function(o){return o.filepath===e})),((function(e){if(Array.isArray(e))return t(e)})(o=a)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(o)||function(e,o){if(e){if("string"==typeof e)return t(e,void 0);var a=Object.prototype.toString.call(e).slice(8,-1);if("Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a)return Array.from(a);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return t(e,void 0)}}(o)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()).sort(function(e,o){return new Date(o.createdAt).getTime()-new Date(e.createdAt).getTime()})}},{key:"formatTime",value:function(e){var o=new Date(0);return o.setSeconds(e),o.toISOString().substr(11,8)}}],function(e,o){for(var t=0;t<o.length;t++){var a=o[t];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}(i.prototype,a),i}();if("undefined"!=typeof iina){var i=iina.standaloneWindow,r=iina.overlay,s=iina.sidebar,n=iina.event,l=iina.console;new a({standaloneWindow:i,overlay:r,sidebar:s,event:n,console:l,menu:iina.menu,core:iina.core,preferences:iina.preferences,iina:iina}),l.log("IINA Bookmarks Plugin with Comprehensive Filtering initialized successfully!")}else console.log("IINA Bookmarks Plugin: Not running in IINA environment")}();
//# sourceMappingURL=index.js.map
