!function(){function e(e,t,r,a,n,o,s){try{var i=e[o](s),l=i.value}catch(e){r(e);return}i.done?t(l):Promise.resolve(l).then(a,n)}function t(t){return function(){var r=this,a=arguments;return new Promise(function(n,o){var s=t.apply(r,a);function i(t){e(s,n,o,i,l,"next",t)}function l(t){e(s,n,o,i,l,"throw",t)}i(void 0)})}}function r(e,t){if(!(e instanceof t))throw TypeError("Cannot call a class as a function")}function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function n(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{},a=Object.keys(r);"function"==typeof Object.getOwnPropertySymbols&&(a=a.concat(Object.getOwnPropertySymbols(r).filter(function(e){return Object.getOwnPropertyDescriptor(r,e).enumerable}))),a.forEach(function(t){var a;a=r[t],t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a})}return e}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=Array(t);r<t;r++)a[r]=e[r];return a}function i(e,t){if(e){if("string"==typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if("Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r)return Array.from(r);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return s(e,t)}}function l(e){return function(e){if(Array.isArray(e))return s(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||i(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function c(e,t){var r,a,n,o={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]},s=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return s.next=i(0),s.throw=i(1),s.return=i(2),"function"==typeof Symbol&&(s[Symbol.iterator]=function(){return this}),s;function i(i){return function(l){var c=[i,l];if(r)throw TypeError("Generator is already executing.");for(;s&&(s=0,c[0]&&(o=0)),o;)try{if(r=1,a&&(n=2&c[0]?a.return:c[0]?a.throw||((n=a.return)&&n.call(a),0):a.next)&&!(n=n.call(a,c[1])).done)return n;switch(a=0,n&&(c=[2&c[0],n.value]),c[0]){case 0:case 1:n=c;break;case 4:return o.label++,{value:c[1],done:!1};case 5:o.label++,a=c[1],c=[0];continue;case 7:c=o.ops.pop(),o.trys.pop();continue;default:if(!(n=(n=o.trys).length>0&&n[n.length-1])&&(6===c[0]||2===c[0])){o=0;continue}if(3===c[0]&&(!n||c[1]>n[0]&&c[1]<n[3])){o.label=c[1];break}if(6===c[0]&&o.label<n[1]){o.label=n[1],n=c;break}if(n&&o.label<n[2]){o.label=n[2],o.ops.push(c);break}n[2]&&o.ops.pop(),o.trys.pop();continue}c=t.call(e,o)}catch(e){c=[6,e],a=0}finally{r=n=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}}}"function"==typeof SuppressedError&&SuppressedError;var u=function(){"use strict";function e(t,a){var n,o,s,i,l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};r(this,e),this.cache=new Map,this.listeners=[],this.currentFilePath=null,this.core=t,this.logger=a,this.config={retryAttempts:null!=(n=l.retryAttempts)?n:3,retryDelay:null!=(o=l.retryDelay)?o:100,cacheTimeout:null!=(s=l.cacheTimeout)?s:3e4,enableLogging:null==(i=l.enableLogging)||i}}return n(e,[{key:"getCurrentTitle",value:function(){return t(function(){var e,t,r,a,n;return c(this,function(o){switch(o.label){case 0:e=Date.now(),o.label=1;case 1:return o.trys.push([1,3,,4]),[4,this.getCurrentMetadata()];case 2:return t=o.sent(),r=Date.now()-e,this.config.enableLogging&&this.logger.log(`Title detection completed in ${r}ms`),[2,t.title||this.extractTitleFromFilename(t.filename)];case 3:return a=o.sent(),n=Date.now()-e,this.logger.error(`Title detection failed after ${n}ms: ${a.message}`),[2,null];case 4:return[2]}})}).call(this)}},{key:"getCurrentFilePath",value:function(){return t(function(){return c(this,function(e){return[2,this.core.status.path||""]})}).call(this)}},{key:"getCurrentMetadata",value:function(){return t(function(){var e,t,r;return c(this,function(a){switch(a.label){case 0:if(!(e=this.core.status.path))throw Error("No media file currently loaded");if(t=this.getCachedMetadata(e))return this.config.enableLogging&&this.logger.log("Using cached metadata for "+e),[2,t];return[4,this.fetchMetadataWithRetry(e)];case 1:return r=a.sent(),this.cacheMetadata(e,r),this.currentFilePath!==e&&(this.currentFilePath=e,this.notifyListeners(r)),[2,r]}})}).call(this)}},{key:"onMediaChange",value:function(e){this.listeners.push(e)}},{key:"removeMediaChangeListener",value:function(e){var t=this.listeners.indexOf(e);t>-1&&this.listeners.splice(t,1)}},{key:"refreshMetadata",value:function(){return t(function(){var e,t;return c(this,function(r){switch(r.label){case 0:if(r.trys.push([0,2,,3]),!(e=this.core.status.path))return[2,null];return this.cache.delete(e),[4,this.getCurrentMetadata()];case 1:return[2,r.sent()];case 2:return t=r.sent(),this.logger.error(`Metadata refresh failed: ${t.message}`),[2,null];case 3:return[2]}})}).call(this)}},{key:"clearExpiredCache",value:function(){var e=Date.now(),t=!0,r=!1,a=void 0;try{for(var n,o=this.cache.entries()[Symbol.iterator]();!(t=(n=o.next()).done);t=!0){var s,l=(s=n.value,function(e){if(Array.isArray(e))return e}(s)||function(e,t){var r,a,n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o=[],s=!0,i=!1;try{for(n=n.call(e);!(s=(r=n.next()).done)&&(o.push(r.value),o.length!==t);s=!0);}catch(e){i=!0,a=e}finally{try{s||null==n.return||n.return()}finally{if(i)throw a}}return o}}(s,2)||i(s,2)||function(){throw TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),c=l[0],u=l[1];e-u.timestamp>this.config.cacheTimeout&&this.cache.delete(c)}}catch(e){r=!0,a=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw a}}}},{key:"fetchMetadataWithRetry",value:function(e){return t(function(){var t,r;return c(this,function(a){switch(a.label){case 0:t=null,r=1,a.label=1;case 1:if(!(r<=this.config.retryAttempts))return[3,8];a.label=2;case 2:return a.trys.push([2,4,,7]),[4,this.fetchMetadata(e)];case 3:return[2,a.sent()];case 4:if(t=a.sent(),!(r<this.config.retryAttempts))return[3,6];return this.config.enableLogging&&this.logger.warn(`Metadata fetch attempt ${r} failed, retrying in ${this.config.retryDelay}ms`),[4,this.delay(this.config.retryDelay)];case 5:a.sent(),a.label=6;case 6:return[3,7];case 7:return r++,[3,1];case 8:throw t||Error("All retry attempts failed")}})}).call(this)}},{key:"fetchMetadata",value:function(e){return t(function(){var t,r,a;return c(this,function(n){return t=e.split("/").pop()||"unknown",(r=this.core.status.title)&&((r=this.normalizeTitle(r))===t||r===t.replace(/\.[^/.]+$/,""))&&(r=void 0),r&&"Unknown Media"!==r||(r=this.extractTitleFromFilename(t)),a={title:r,filename:t,filepath:e,duration:this.core.status.duration,format:this.extractFormat(t)},this.config.enableLogging&&this.logger.log(`Fetched metadata for ${t}: title="${r}"`),[2,a]})}).call(this)}},{key:"normalizeTitle",value:function(e){return e.trim().replace(/[\u0000-\u001F\u007F-\u009F]/g,"").replace(/\s+/g," ").replace(/^["']|["']$/g,"").slice(0,200)}},{key:"extractTitleFromFilename",value:function(e){var t=e.replace(/\.[^/.]+$/,"");return(t=(t=(t=t.replace(/[._-]/g," ").replace(/\s+/g," ").trim()).replace(/\b(19|20)\d{2}\b/g,"").replace(/\b(720p|1080p|1440p|2160p|4k)\b/gi,"").replace(/\b(BluRay|BDRip|DVDRip|WEB-DL|HDTV)\b/gi,"").replace(/\b(x264|x265|H264|H265|HEVC)\b/gi,"").replace(/\s+/g," ").trim()).replace(/\b\w/g,function(e){return e.toUpperCase()}))||"Unknown Media"}},{key:"extractFormat",value:function(e){var t;return(null==(t=e.split(".").pop())?void 0:t.toLowerCase())||"unknown"}},{key:"getCachedMetadata",value:function(e){var t=this.cache.get(e);return t?Date.now()-t.timestamp>this.config.cacheTimeout?(this.cache.delete(e),null):t.metadata:null}},{key:"cacheMetadata",value:function(e,t){this.cache.set(e,{metadata:t,timestamp:Date.now()})}},{key:"notifyListeners",value:function(e){var t=!0,r=!1,a=void 0;try{for(var n,o=this.listeners[Symbol.iterator]();!(t=(n=o.next()).done);t=!0){var s=n.value;try{s(e)}catch(e){this.logger.error(`Error in metadata change listener: ${e.message}`)}}}catch(e){r=!0,a=e}finally{try{t||null==o.return||o.return()}finally{if(r)throw a}}}},{key:"delay",value:function(e){return new Promise(function(t){return setTimeout(t,e)})}}]),e}(),d=function(){"use strict";function e(t){r(this,e),this.bookmarks=[],this.STORAGE_KEY="bookmarks",this.SORT_PREFERENCES_KEY="sortPreferences",this.deps=t||{console:{log:function(){},error:function(){},warn:function(){}},preferences:{get:function(){return null},set:function(){}},core:{status:{}},event:{on:function(){}},menu:{addItem:function(){},item:function(){return{}}},sidebar:{loadFile:function(){},postMessage:function(){},onMessage:function(){}},overlay:{loadFile:function(){},postMessage:function(){},onMessage:function(){},setClickable:function(){},show:function(){},hide:function(){},isVisible:function(){return!1}},standaloneWindow:{loadFile:function(){},postMessage:function(){},onMessage:function(){},show:function(){}}},this.metadataDetector=new u(this.deps.core,this.deps.console,{retryAttempts:3,retryDelay:100,cacheTimeout:3e4,enableLogging:!0}),this.loadBookmarks(),this.loadSortPreferences(),t&&(this.setupEventListeners(),this.setupWebUI(),this.setupUIMessageListeners(),this.setupMetadataChangeListener(),this.deps.console.log("IINA Bookmarks Plugin with enhanced metadata detection initialized. Message passing enabled."))}return n(e,[{key:"setupWebUI",value:function(){try{this.deps.sidebar.loadFile("dist/ui/sidebar/index.html"),this.deps.overlay.loadFile("dist/ui/overlay/index.html"),this.deps.overlay.setClickable(!0),this.deps.overlay.hide(),this.deps.standaloneWindow.loadFile("dist/ui/window/index.html"),this.deps.console.log("Web UIs loaded successfully.")}catch(e){this.deps.console.error(`Error loading Web UIs: ${e.message}`)}}},{key:"setupUIMessageListeners",value:function(){var e=this,t=function(t){return function(r){if("string"==typeof r)try{a=JSON.parse(r)}catch(a){e.deps.console.error(`[${t}] Error parsing JSON message:`,r,a);return}else{if("object"!=typeof r||null===r||!("type"in r))return void e.deps.console.warn(`[${t}] Received non-standard message:`,r);a=r}switch(e.deps.console.log(`[${t}] Received message:`,a),a.type){case"REQUEST_FILE_PATH":var a,n,o,s,i,l,c,u,d,p,h=e.deps.core.status.path;("overlay"===t?e.deps.overlay:"sidebar"===t?e.deps.sidebar:e.deps.standaloneWindow).postMessage(JSON.stringify({type:"CURRENT_FILE_PATH",data:h}));break;case"JUMP_TO_BOOKMARK":(null==(n=a.payload)?void 0:n.id)&&e.jumpToBookmark(a.payload.id);break;case"HIDE_OVERLAY":e.deps.overlay.hide();break;case"ADD_BOOKMARK":e.addBookmark(null==(o=a.payload)?void 0:o.title,null==(s=a.payload)?void 0:s.timestamp,null==(i=a.payload)?void 0:i.description,null==(l=a.payload)?void 0:l.tags).catch(function(t){return e.deps.console.error("Failed to add bookmark:",t.message)});break;case"DELETE_BOOKMARK":(null==(c=a.payload)?void 0:c.id)&&e.removeBookmark(a.payload.id);break;case"UPDATE_BOOKMARK":(null==(u=a.payload)?void 0:u.id)&&(null==(d=a.payload)?void 0:d.data)&&e.updateBookmark(a.payload.id,a.payload.data);break;case"UI_READY":var f="overlay"===t?e.deps.overlay:"sidebar"===t?e.deps.sidebar:e.deps.standaloneWindow,g=e.getBookmarks(e.deps.core.status.path||void 0);f.postMessage(JSON.stringify({type:"BOOKMARKS_UPDATED",data:g})),e.deps.console.log(`Sent initial bookmarks to ${t} for path: ${e.deps.core.status.path}`);break;case"SAVE_SORT_PREFERENCES":(null==(p=a.payload)?void 0:p.preferences)&&e.saveSortPreferences(a.payload.preferences);break;case"REQUEST_BOOKMARK_DEFAULTS":e.getBookmarkDefaults().then(function(r){("overlay"===t?e.deps.overlay:"sidebar"===t?e.deps.sidebar:e.deps.standaloneWindow).postMessage(JSON.stringify({type:"BOOKMARK_DEFAULTS",data:r}))}).catch(function(t){return e.deps.console.error("Failed to get bookmark defaults:",t.message)});break;case"EXPORT_BOOKMARKS":e.handleExportBookmarks(a.payload,t);break;default:e.deps.console.warn(`[${t}] Unknown message type:`,a.type)}}};this.deps.sidebar.onMessage(t("sidebar")),this.deps.overlay.onMessage(t("overlay")),this.deps.standaloneWindow.onMessage(t("window")),this.deps.console.log("UI Message Listeners are set up.")}},{key:"setupMetadataChangeListener",value:function(){var e=this;this.metadataDetector.onMediaChange(function(t){e.deps.console.log(`Media changed: ${t.title} (${t.filepath})`),e.refreshUIs()})}},{key:"loadBookmarks",value:function(){try{var e=this.deps.preferences.get(this.STORAGE_KEY);if(e){var t=JSON.parse(e);this.bookmarks=t.map(function(e){var t,r;return t=o({},e),r={createdAt:e.createdAt?new Date(e.createdAt).toISOString():new Date().toISOString()},r=null!=r?r:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):(function(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);r.push.apply(r,a)}return r})(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}),t})}this.deps.console.log("Bookmarks loaded:",this.bookmarks.length)}catch(e){this.deps.console.error("Error loading bookmarks:",e.message),this.bookmarks=[]}}},{key:"saveBookmarks",value:function(){try{this.deps.preferences.set(this.STORAGE_KEY,JSON.stringify(this.bookmarks)),this.deps.console.log("Bookmarks saved."),this.refreshUIs()}catch(e){this.deps.console.error("Error saving bookmarks:",e.message)}}},{key:"refreshUIs",value:function(e){var t=this.deps.core.status.path,r=this.getBookmarks(t||void 0),a=JSON.stringify({type:"BOOKMARKS_UPDATED",data:r});this.deps.console.log(`Refreshing UIs. Specific: ${e||"all"}. Path: ${t}. Count: ${r.length}`);try{e&&"sidebar"!==e||this.deps.sidebar.postMessage(a),e&&"overlay"!==e||this.deps.overlay.postMessage(a),e&&"window"!==e||this.deps.standaloneWindow.postMessage(a)}catch(e){this.deps.console.warn("Could not refresh one or more UIs. They might not be loaded yet.",e.message)}}},{key:"setupEventListeners",value:function(){var e=this;this.deps.event.on("file-loaded",function(){e.deps.console.log("File loaded event triggered."),e.metadataDetector.refreshMetadata().then(function(){return e.refreshUIs()}).catch(function(t){return e.deps.console.error("Failed to refresh metadata on file load:",t.message)})}),this.deps.menu.addItem(this.deps.menu.item("Add Bookmark at Current Time",function(){e.addBookmark().catch(function(t){return e.deps.console.error("Failed to add bookmark from menu:",t.message)})})),this.deps.menu.addItem(this.deps.menu.item("Manage Bookmarks",function(){e.deps.standaloneWindow.show()})),this.deps.menu.addItem(this.deps.menu.item("Toggle Bookmarks Overlay",function(){e.deps.overlay.isVisible()?e.deps.overlay.hide():(e.refreshUIs("overlay"),e.deps.overlay.show())}))}},{key:"getBookmarkDefaults",value:function(){return t(function(){var e,t,r,a,n,o;return c(this,function(s){switch(s.label){case 0:s.trys.push([0,5,,6]),e=this.deps.core.status.path||"/test/video.mp4",t=this.deps.core.status.currentTime||0,s.label=1;case 1:return s.trys.push([1,3,,4]),[4,this.metadataDetector.getCurrentTitle()];case 2:return r=s.sent()||"Unknown Media",[3,4];case 3:return a=s.sent(),this.deps.console.warn(`Metadata detection failed: ${a.message}`),r=(e.split("/").pop()||e).replace(/\.[^/.]+$/,"")||"Unknown Media",[3,4];case 4:return[2,{title:(n=this.generateBookmarkMetadata(e,r,t)).title,description:n.description||"",tags:n.tags||[],timestamp:t,filepath:e}];case 5:throw o=s.sent(),this.deps.console.error("Error getting bookmark defaults:",o.message),o;case 6:return[2]}})}).call(this)}},{key:"addBookmark",value:function(e,r,a,n){return t(function(){var t,o,s,i,l,u,d;return c(this,function(c){switch(c.label){case 0:c.trys.push([0,5,,6]),t=this.deps.core.status.path||"/test/video.mp4",o=void 0!==r?r:this.deps.core.status.currentTime||0,c.label=1;case 1:return c.trys.push([1,3,,4]),[4,this.metadataDetector.getCurrentTitle()];case 2:return s=c.sent()||"Unknown Media",[3,4];case 3:return i=c.sent(),this.deps.console.warn(`Metadata detection failed: ${i.message}`),s=(t.split("/").pop()||t).replace(/\.[^/.]+$/,"")||"Unknown Media",[3,4];case 4:return l=this.generateBookmarkMetadata(t,s,o,e,a,n),u={id:this.generateUniqueId(),title:l.title,timestamp:o,filepath:t,description:l.description,createdAt:new Date().toISOString(),tags:l.tags},this.bookmarks.push(u),this.saveBookmarks(),this.deps.console.log("Bookmark added with enhanced metadata detection:",u.title),[3,6];case 5:throw d=c.sent(),this.deps.console.error("Error adding bookmark:",d.message),d;case 6:return[2]}})}).call(this)}},{key:"generateUniqueId",value:function(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}},{key:"generateBookmarkMetadata",value:function(e,t,r,a,n,o){var s,i,l=(null==(s=e.split(".").pop())?void 0:s.toLowerCase())||"",c=this.getMediaType(l);if(void 0!==o)i=o.length>0?o:void 0;else{var u=this.generateAutoTags(e,l,t,r);i=u.length>0?u:void 0}return{title:a||`${t} - ${this.formatTime(r)}`,description:n||`Bookmark at ${this.formatTime(r)} in ${c}`,tags:i}}},{key:"getMediaType",value:function(e){return["mp4","avi","mkv","mov","wmv","flv","m4v"].includes(e)?"video":["mp3","wav","flac","aac","m4a","ogg"].includes(e)?"audio":"media"}},{key:"generateAutoTags",value:function(e,t,r,a){var n=[],o=this.getMediaType(t);n.push(o);var s=Math.floor(a/60);s<5?n.push("beginning"):s<60?n.push("early"):s>=120&&n.push("late");var i=e.toLowerCase().split("/"),l=["movies","tv","shows","series","music","videos","downloads"];i.forEach(function(e){l.includes(e)&&n.push(e.replace("movies","movie").replace("shows","tv-show"))});var c=r.toLowerCase();return[{pattern:/season\s*(\d+)/i,tag:"tv-series"},{pattern:/s(\d+)e(\d+)/i,tag:"tv-episode"},{pattern:/episode\s*(\d+)/i,tag:"episode"},{pattern:/(19|20)\d{2}/i,tag:"dated-content"},{pattern:/trailer/i,tag:"trailer"},{pattern:/interview/i,tag:"interview"},{pattern:/behind.the.scenes|behind.scenes|bts/i,tag:"behind-scenes"},{pattern:/documentary|docu/i,tag:"documentary"},{pattern:/concert|live/i,tag:"live-performance"}].forEach(function(e){var t=e.pattern,r=e.tag;t.test(c)&&n.push(r)}),[{pattern:/\b4k\b|2160p/i,tag:"4k"},{pattern:/\b1080p?\b/i,tag:"hd"},{pattern:/\b720p?\b/i,tag:"hd"},{pattern:/\bhdr\b/i,tag:"hdr"}].forEach(function(t){var a=t.pattern,o=t.tag;(a.test(e)||a.test(r))&&n.push(o)}),n.filter(function(e,t,r){return r.indexOf(e)===t})}},{key:"removeBookmark",value:function(e){this.bookmarks=this.bookmarks.filter(function(t){return t.id!==e}),this.saveBookmarks(),this.deps.console.log("Bookmark removed:",e)}},{key:"updateBookmark",value:function(e,t){var r=this.bookmarks.findIndex(function(t){return t.id===e});-1!==r&&(this.bookmarks[r]=o({},this.bookmarks[r],t),this.saveBookmarks(),this.deps.console.log("Bookmark updated:",e))}},{key:"jumpToBookmark",value:function(e){var t=this.bookmarks.find(function(t){return t.id===e});if(!t)return void this.deps.console.error("Bookmark not found:",e);this.deps.console.log(`Jumping to bookmark: ${t.title} at ${this.formatTime(t.timestamp)} in ${t.filepath}`)}},{key:"getBookmarks",value:function(e){return e?this.bookmarks.filter(function(t){return t.filepath===e}):l(this.bookmarks)}},{key:"formatTime",value:function(e){var t=Math.floor(e/3600),r=Math.floor(e%3600/60),a=Math.floor(e%60);return t>0?`${t}:${r.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`:`${r}:${a.toString().padStart(2,"0")}`}},{key:"loadSortPreferences",value:function(){try{var e=this.deps.preferences.get(this.SORT_PREFERENCES_KEY);e&&this.deps.console.log("Sort preferences loaded:",e)}catch(e){this.deps.console.error("Error loading sort preferences:",e.message)}}},{key:"saveSortPreferences",value:function(e){try{this.deps.preferences.set(this.SORT_PREFERENCES_KEY,JSON.stringify(e)),this.deps.console.log("Sort preferences saved:",e)}catch(e){this.deps.console.error("Error saving sort preferences:",e.message)}}},{key:"handleExportBookmarks",value:function(e,r){return t(function(){var t,a,n;return c(this,function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),this.deps.console.log("Starting export with options:",e),t=this.getFilteredBookmarksForExport(e),[4,this.exportBookmarks(t,e)];case 1:return a=o.sent(),("overlay"===r?this.deps.overlay:"sidebar"===r?this.deps.sidebar:this.deps.standaloneWindow).postMessage(JSON.stringify({type:"EXPORT_RESULT",data:a})),this.deps.console.log(`Export completed: ${a.recordCount} records exported`),[3,3];case 2:return n=o.sent(),this.deps.console.error(`Export failed: ${n.message}`),("overlay"===r?this.deps.overlay:"sidebar"===r?this.deps.sidebar:this.deps.standaloneWindow).postMessage(JSON.stringify({type:"EXPORT_RESULT",data:{success:!1,recordCount:0,error:n.message}})),[3,3];case 3:return[2]}})}).call(this)}},{key:"getFilteredBookmarksForExport",value:function(e){var t=this,r=l(this.bookmarks);if(e.filter){if(e.filter.tags&&e.filter.tags.length>0&&(r=r.filter(function(t){return t.tags&&t.tags.some(function(t){return e.filter.tags.includes(t)})})),e.filter.dateRange){var a=new Date(e.filter.dateRange.start),n=new Date(e.filter.dateRange.end);r=r.filter(function(e){var t=new Date(e.createdAt);return t>=a&&t<=n})}e.filter.mediaType&&(r=r.filter(function(r){var a,n=(null==(a=r.filepath.split(".").pop())?void 0:a.toLowerCase())||"";return t.getMediaType(n).toLowerCase().includes(e.filter.mediaType.toLowerCase())}))}return r}},{key:"exportBookmarks",value:function(e,r){return t(function(){return c(this,function(t){if("json"===r.format)return[2,this.exportBookmarksToJSON(e,r)];if("csv"===r.format)return[2,this.exportBookmarksToCSV(e,r)];throw Error(`Unsupported export format: ${r.format}`)})}).call(this)}},{key:"exportBookmarksToJSON",value:function(e,t){try{var r={metadata:t.includeMetadata?{exportedAt:new Date().toISOString(),totalRecords:e.length,exportOptions:t,version:"1.0.0"}:void 0,bookmarks:e},a=JSON.stringify(r,null,2),n=new Date().toISOString().replace(/[:.]/g,"-"),o=t.filePath||`bookmarks-export-${n}.json`;return{success:!0,filePath:o,recordCount:e.length,data:a}}catch(e){return{success:!1,recordCount:0,error:`JSON export failed: ${e.message}`}}}},{key:"exportBookmarksToCSV",value:function(e,t){var r=this;try{var a=t.delimiter||",",n=t.selectedFields.length>0?t.selectedFields:["id","title","timestamp","filepath","description","createdAt","tags"],o="";t.includeHeaders&&(o+=n.join(a)+"\n");var s=!0,i=!1,l=void 0;try{for(var c,u=e[Symbol.iterator]();!(s=(c=u.next()).done);s=!0)!function(){var e=c.value,t=n.map(function(t){var n=e[t];"tags"===t&&Array.isArray(n)?n=n.join(";"):"timestamp"===t?n=`${n} (${r.formatTime(n)})`:null==n&&(n="");var o=String(n);return o.includes(a)||o.includes('"')||o.includes("\n")?`"${o.replace(/"/g,'""')}"`:o});o+=t.join(a)+"\n"}()}catch(e){i=!0,l=e}finally{try{s||null==u.return||u.return()}finally{if(i)throw l}}var d=new Date().toISOString().replace(/[:.]/g,"-"),p=t.filePath||`bookmarks-export-${d}.csv`;return{success:!0,filePath:p,recordCount:e.length,data:o}}catch(e){return{success:!1,recordCount:0,error:`CSV export failed: ${e.message}`}}}},{key:"validateExportData",value:function(e){for(var t=[],r=0;r<e.length;r++){var a=e[r];a.id||t.push(`Bookmark at index ${r} missing required field: id`),a.title||t.push(`Bookmark at index ${r} missing required field: title`),"number"!=typeof a.timestamp&&t.push(`Bookmark at index ${r} invalid timestamp: ${a.timestamp}`),a.filepath||t.push(`Bookmark at index ${r} missing required field: filepath`),a.createdAt||t.push(`Bookmark at index ${r} missing required field: createdAt`)}return{isValid:0===t.length,errors:t}}}]),e}();if("undefined"!=typeof iina){var p=iina.standaloneWindow,h=iina.overlay,f=iina.sidebar,g=iina.event,m=iina.console,y=iina.menu,v=iina.core;new d({console:m,preferences:iina.preferences,core:v,event:g,menu:y,sidebar:f,overlay:h,standaloneWindow:p}),m.log("IINA Bookmarks Plugin with Multi-Criteria Sorting and Comprehensive Filtering initialized successfully!")}else console.log("IINA Bookmarks Plugin: Not running in IINA environment")}();
//# sourceMappingURL=index.js.map
