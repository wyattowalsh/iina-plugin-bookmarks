!function(){function e(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},s=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(s=s.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),s.forEach(function(t){var s;s=o[t],t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s})}return e}function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,s=Array(t);o<t;o++)s[o]=e[o];return s}function o(e){return function(e){if(Array.isArray(e))return t(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,o){if(e){if("string"==typeof e)return t(e,void 0);var s=Object.prototype.toString.call(e).slice(8,-1);if("Object"===s&&e.constructor&&(s=e.constructor.name),"Map"===s||"Set"===s)return Array.from(s);if("Arguments"===s||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(s))return t(e,o)}}(e)||function(){throw TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var s=function(){"use strict";var t;function s(e){if(!(this instanceof s))throw TypeError("Cannot call a class as a function");this.bookmarks=[],this.STORAGE_KEY="bookmarks",this.SORT_PREFERENCES_KEY="sortPreferences",this.deps=e||{console:{log:function(){},error:function(){},warn:function(){}},preferences:{get:function(){return null},set:function(){}},core:{status:{}},event:{on:function(){}},menu:{addItem:function(){},item:function(){return{}}},sidebar:{loadFile:function(){},postMessage:function(){},onMessage:function(){}},overlay:{loadFile:function(){},postMessage:function(){},onMessage:function(){},setClickable:function(){},show:function(){},hide:function(){},isVisible:function(){return!1}},standaloneWindow:{loadFile:function(){},postMessage:function(){},onMessage:function(){},show:function(){}}},this.loadBookmarks(),this.loadSortPreferences(),e&&(this.setupEventListeners(),this.setupWebUI(),this.setupUIMessageListeners(),this.deps.console.log("IINA Bookmarks Plugin initialized. Message passing enabled."))}return t=[{key:"setupWebUI",value:function(){try{this.deps.sidebar.loadFile("dist/ui/sidebar/index.html"),this.deps.overlay.loadFile("dist/ui/overlay/index.html"),this.deps.overlay.setClickable(!0),this.deps.overlay.hide(),this.deps.standaloneWindow.loadFile("dist/ui/window/index.html"),this.deps.console.log("Web UIs loaded successfully.")}catch(e){this.deps.console.error(`Error loading Web UIs: ${e.message}`)}}},{key:"setupUIMessageListeners",value:function(){var e=this,t=function(t){return function(o){if("string"==typeof o)try{s=JSON.parse(o)}catch(s){e.deps.console.error(`[${t}] Error parsing JSON message:`,o,s);return}else{if("object"!=typeof o||null===o||!("type"in o))return void e.deps.console.warn(`[${t}] Received non-standard message:`,o);s=o}switch(e.deps.console.log(`[${t}] Received message:`,s),s.type){case"REQUEST_FILE_PATH":var s,r,a,n,i,d,l,c,p,u,f=e.deps.core.status.path;("overlay"===t?e.deps.overlay:"sidebar"===t?e.deps.sidebar:e.deps.standaloneWindow).postMessage(JSON.stringify({type:"CURRENT_FILE_PATH",data:f}));break;case"JUMP_TO_BOOKMARK":(null==(r=s.payload)?void 0:r.id)&&e.jumpToBookmark(s.payload.id);break;case"HIDE_OVERLAY":e.deps.overlay.hide();break;case"ADD_BOOKMARK":e.addBookmark(null==(a=s.payload)?void 0:a.title,null==(n=s.payload)?void 0:n.timestamp,null==(i=s.payload)?void 0:i.description,null==(d=s.payload)?void 0:d.tags);break;case"DELETE_BOOKMARK":(null==(l=s.payload)?void 0:l.id)&&e.removeBookmark(s.payload.id);break;case"UPDATE_BOOKMARK":(null==(c=s.payload)?void 0:c.id)&&(null==(p=s.payload)?void 0:p.data)&&e.updateBookmark(s.payload.id,s.payload.data);break;case"UI_READY":var h="overlay"===t?e.deps.overlay:"sidebar"===t?e.deps.sidebar:e.deps.standaloneWindow,m=e.getBookmarks(e.deps.core.status.path||void 0);h.postMessage(JSON.stringify({type:"BOOKMARKS_UPDATED",data:m})),e.deps.console.log(`Sent initial bookmarks to ${t} for path: ${e.deps.core.status.path}`);break;case"SAVE_SORT_PREFERENCES":(null==(u=s.payload)?void 0:u.preferences)&&e.saveSortPreferences(s.payload.preferences);break;default:e.deps.console.warn(`[${t}] Unknown message type:`,s.type)}}};this.deps.sidebar.onMessage(t("sidebar")),this.deps.overlay.onMessage(t("overlay")),this.deps.standaloneWindow.onMessage(t("window")),this.deps.console.log("UI Message Listeners are set up.")}},{key:"loadBookmarks",value:function(){try{var t=this.deps.preferences.get(this.STORAGE_KEY);if(t){var o=JSON.parse(t);this.bookmarks=o.map(function(t){var o,s;return o=e({},t),s={createdAt:t.createdAt?new Date(t.createdAt).toISOString():new Date().toISOString()},s=null!=s?s:{},Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(s)):(function(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);o.push.apply(o,s)}return o})(Object(s)).forEach(function(e){Object.defineProperty(o,e,Object.getOwnPropertyDescriptor(s,e))}),o})}this.deps.console.log("Bookmarks loaded:",this.bookmarks.length)}catch(e){this.deps.console.error("Error loading bookmarks:",e.message),this.bookmarks=[]}}},{key:"saveBookmarks",value:function(){try{this.deps.preferences.set(this.STORAGE_KEY,JSON.stringify(this.bookmarks)),this.deps.console.log("Bookmarks saved."),this.refreshUIs()}catch(e){this.deps.console.error("Error saving bookmarks:",e.message)}}},{key:"refreshUIs",value:function(e){var t=this.deps.core.status.path,o=this.getBookmarks(t||void 0),s=JSON.stringify({type:"BOOKMARKS_UPDATED",data:o});this.deps.console.log(`Refreshing UIs. Specific: ${e||"all"}. Path: ${t}. Count: ${o.length}`);try{e&&"sidebar"!==e||this.deps.sidebar.postMessage(s),e&&"overlay"!==e||this.deps.overlay.postMessage(s),e&&"window"!==e||this.deps.standaloneWindow.postMessage(s)}catch(e){this.deps.console.warn("Could not refresh one or more UIs. They might not be loaded yet.",e.message)}}},{key:"setupEventListeners",value:function(){var e=this;this.deps.event.on("file-loaded",function(){e.deps.console.log("File loaded event triggered."),e.refreshUIs()}),this.deps.menu.addItem(this.deps.menu.item("Add Bookmark at Current Time",function(){e.addBookmark()})),this.deps.menu.addItem(this.deps.menu.item("Manage Bookmarks",function(){e.deps.standaloneWindow.show()})),this.deps.menu.addItem(this.deps.menu.item("Toggle Bookmarks Overlay",function(){e.deps.overlay.isVisible()?e.deps.overlay.hide():(e.refreshUIs("overlay"),e.deps.overlay.show())}))}},{key:"addBookmark",value:function(e,t,o,s){var r=this.deps.core.status.path||"/test/video.mp4",a=void 0!==t?t:this.deps.core.status.currentTime||0,n=this.extractMediaTitle(r),i=this.generateBookmarkMetadata(r,n,a,e,o,s),d={id:this.generateUniqueId(),title:i.title,timestamp:a,filepath:r,description:i.description,createdAt:new Date().toISOString(),tags:i.tags};this.bookmarks.push(d),this.saveBookmarks(),this.deps.console.log("Bookmark added:",d.title)}},{key:"extractMediaTitle",value:function(e){return(e.split("/").pop()||e).replace(/\.[^/.]+$/,"")}},{key:"generateUniqueId",value:function(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}},{key:"generateBookmarkMetadata",value:function(e,t,s,r,a,n){var i,d=(null==(i=e.split(".").pop())?void 0:i.toLowerCase())||"",l=this.getMediaType(d),c=this.generateAutoTags(e,d,t,s),p=o(new Set(o(n||[]).concat(o(c))));return{title:r||`${t} - ${this.formatTime(s)}`,description:a||`Bookmark at ${this.formatTime(s)} in ${l}`,tags:p.length>0?p:void 0}}},{key:"getMediaType",value:function(e){return["mp4","avi","mkv","mov","wmv","flv","m4v"].includes(e)?"video":["mp3","wav","flac","aac","m4a","ogg"].includes(e)?"audio":"media"}},{key:"generateAutoTags",value:function(e,t,o,s){var r=[],a=this.getMediaType(t);r.push(a);var n=Math.floor(s/60);n<5?r.push("beginning"):n<60?r.push("early"):n>=120&&r.push("late");var i=e.toLowerCase().split("/"),d=["movies","tv","shows","series","music","videos","downloads"];i.forEach(function(e){d.includes(e)&&r.push(e.replace("movies","movie").replace("shows","tv-show"))});var l=o.toLowerCase();return[{pattern:/season\s*(\d+)/i,tag:"tv-series"},{pattern:/s(\d+)e(\d+)/i,tag:"tv-episode"},{pattern:/episode\s*(\d+)/i,tag:"episode"},{pattern:/(19|20)\d{2}/i,tag:"dated-content"},{pattern:/trailer/i,tag:"trailer"},{pattern:/interview/i,tag:"interview"},{pattern:/behind.the.scenes|behind.scenes|bts/i,tag:"behind-scenes"},{pattern:/documentary|docu/i,tag:"documentary"},{pattern:/concert|live/i,tag:"live-performance"}].forEach(function(e){var t=e.pattern,o=e.tag;t.test(l)&&r.push(o)}),[{pattern:/\b4k\b|2160p/i,tag:"4k"},{pattern:/\b1080p?\b/i,tag:"hd"},{pattern:/\b720p?\b/i,tag:"hd"},{pattern:/\bhdr\b/i,tag:"hdr"}].forEach(function(t){var s=t.pattern,a=t.tag;(s.test(e)||s.test(o))&&r.push(a)}),r.filter(function(e,t,o){return o.indexOf(e)===t})}},{key:"removeBookmark",value:function(e){this.bookmarks=this.bookmarks.filter(function(t){return t.id!==e}),this.saveBookmarks(),this.deps.console.log("Bookmark removed:",e)}},{key:"updateBookmark",value:function(t,o){var s=this.bookmarks.findIndex(function(e){return e.id===t});-1!==s&&(this.bookmarks[s]=e({},this.bookmarks[s],o),this.saveBookmarks(),this.deps.console.log("Bookmark updated:",t))}},{key:"jumpToBookmark",value:function(e){var t=this.bookmarks.find(function(t){return t.id===e});if(!t)return void this.deps.console.error("Bookmark not found:",e);this.deps.console.log(`Jumping to bookmark: ${t.title} at ${this.formatTime(t.timestamp)} in ${t.filepath}`)}},{key:"getBookmarks",value:function(e){return e?this.bookmarks.filter(function(t){return t.filepath===e}):o(this.bookmarks)}},{key:"formatTime",value:function(e){var t=Math.floor(e/3600),o=Math.floor(e%3600/60),s=Math.floor(e%60);return t>0?`${t}:${o.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`:`${o}:${s.toString().padStart(2,"0")}`}},{key:"loadSortPreferences",value:function(){try{var e=this.deps.preferences.get(this.SORT_PREFERENCES_KEY);e&&this.deps.console.log("Sort preferences loaded:",e)}catch(e){this.deps.console.error("Error loading sort preferences:",e.message)}}},{key:"saveSortPreferences",value:function(e){try{this.deps.preferences.set(this.SORT_PREFERENCES_KEY,JSON.stringify(e)),this.deps.console.log("Sort preferences saved:",e)}catch(e){this.deps.console.error("Error saving sort preferences:",e.message)}}}],function(e,t){for(var o=0;o<t.length;o++){var s=t[o];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}(s.prototype,t),s}();if("undefined"!=typeof iina){var r=iina.standaloneWindow,a=iina.overlay,n=iina.sidebar,i=iina.event,d=iina.console,l=iina.menu,c=iina.core;new s({console:d,preferences:iina.preferences,core:c,event:i,menu:l,sidebar:n,overlay:a,standaloneWindow:r}),d.log("IINA Bookmarks Plugin with Metadata Auto-Population initialized successfully!")}else console.log("IINA Bookmarks Plugin: Not running in IINA environment");new s}();
//# sourceMappingURL=index.js.map
