---
title: BookmarkManager API
description: Complete API reference for the BookmarkManager class with methods, interfaces, and examples
icon: Code
---

import { Callout } from 'fumadocs-ui/components/callout';
import { Step, Steps } from 'fumadocs-ui/components/steps';
import { Tabs, Tab } from 'fumadocs-ui/components/tabs';
import { Card, Cards } from 'fumadocs-ui/components/card';

# BookmarkManager API Reference

Complete technical reference for the `BookmarkManager` class, the core component responsible for all bookmark operations, data management, and system integration.

## ðŸ—ï¸ Class Overview

```typescript
export class BookmarkManager {
  // Core properties
  private bookmarks: BookmarkData[];
  private readonly STORAGE_KEY = "bookmarks";
  private deps: IINADependencies;
  private metadataDetector: MetadataDetector;
  private cache: BookmarkCache;

  // Performance optimizations
  private debouncedSave: (...args: any[]) => void;
  private debouncedRefreshUIs: (...args: any[]) => void;
  private memoizedGetBookmarks: (filePath?: string) => BookmarkData[];

  constructor(dependencies?: IINADependencies);
}
```

<Callout type="info" title="Architecture Note">
  The BookmarkManager follows a **dependency injection pattern** for testability and uses **performance optimizations** including caching, debouncing, and memoization.
</Callout>

## ðŸ“š Core Methods

<Tabs items={['Bookmark Operations', 'Data Management', 'Search & Filter', 'Performance']}>
  <Tab value="Bookmark Operations">
    ### Bookmark CRUD Operations
    
    #### `addBookmark()`
    
    Creates a new bookmark with intelligent defaults and validation.
    
    ```typescript
    async addBookmark(
      title?: string,           // Custom title (optional, auto-detected if not provided)
      timestamp?: number,       // Playback position (optional, uses current time)
      description?: string,     // User description (optional)
      tags?: string[]          // Custom tags (optional, auto-generated if not provided)
    ): Promise<void>
    ```
    
    **Example Usage:**
    ```typescript
    // Quick bookmark with auto-detection
    await bookmarkManager.addBookmark();
    
    // Custom bookmark with specific details
    await bookmarkManager.addBookmark(
      "Epic Battle Scene",
      2847.5,
      "Amazing fight choreography with practical effects",
      ["action", "favorite", "climax"]
    );
    ```
    
    **Behavior:**
    - **Auto-detection**: Title extracted from media metadata or filename
    - **Timestamp capture**: Uses current playback position if not specified
    - **Validation**: Ensures all required fields are present and valid
    - **Duplicate prevention**: Checks for existing bookmarks at same timestamp
    - **Performance**: Uses debounced save to prevent excessive I/O
    
    ---
    
    #### `removeBookmark()`
    
    Removes a bookmark by ID with optimized lookup.
    
    ```typescript
    removeBookmark(id: string): void
    ```
    
    **Example Usage:**
    ```typescript
    bookmarkManager.removeBookmark("bookmark_1695740123456_a1b2c3");
    ```
    
    **Behavior:**
    - **Cache optimization**: Uses indexed cache for O(1) lookup
    - **Fallback safety**: Falls back to linear search if cache miss
    - **Automatic save**: Triggers debounced save operation
    - **UI refresh**: Updates all connected interfaces
    
    ---
    
    #### `updateBookmark()`
    
    Updates bookmark properties with validation and change tracking.
    
    ```typescript
    updateBookmark(
      id: string,
      data: Partial<Omit<BookmarkData, 'id' | 'filepath' | 'createdAt'>>
    ): void
    ```
    
    **Example Usage:**
    ```typescript
    bookmarkManager.updateBookmark("bookmark_123", {
      title: "Updated Scene Title",
      description: "Added more context about this scene",
      tags: ["updated", "enhanced", "favorite"]
    });
    ```
    
    **Behavior:**
    - **Partial updates**: Only specified fields are modified
    - **Immutable fields**: ID, filepath, and createdAt cannot be changed
    - **Validation**: Validates all changes before applying
    - **Change tracking**: Logs modifications for debugging
    
    ---
    
    #### `jumpToBookmark()`
    
    Navigates to a bookmark's timestamp in the current media.
    
    ```typescript
    jumpToBookmark(id: string): void
    ```
    
    **Example Usage:**
    ```typescript
    bookmarkManager.jumpToBookmark("bookmark_1695740123456_a1b2c3");
    ```
    
    **Behavior:**
    - **Media synchronization**: Works with currently loaded media file
    - **Validation**: Ensures bookmark exists and is valid
    - **UI feedback**: Provides visual confirmation of jump
    - **Error handling**: Graceful failure for invalid bookmarks
  </Tab>
  
  <Tab value="Data Management">
    ### Export/Import Operations
    
    #### `exportBookmarks()`
    
    Exports bookmark data with advanced filtering and format options.
    
    ```typescript
    private async exportBookmarks(
      bookmarks: BookmarkData[],
      options: ExportOptions
    ): Promise<ExportResult>
    ```
    
    **Export Options Interface:**
    ```typescript
    interface ExportOptions {
      format: 'json' | 'csv';
      includeMetadata: boolean;
      compressOutput?: boolean;
      filePath?: string;
      filter?: {
        tags?: string[];
        dateRange?: { start: string; end: string };
        mediaType?: string;
      };
    }
    ```
    
    **Example Usage:**
    ```typescript
    const exportResult = await bookmarkManager.exportBookmarks(
      bookmarks,
      {
        format: 'json',
        includeMetadata: true,
        filePath: '/exports/my-bookmarks.json',
        filter: {
          tags: ['favorite', 'important'],
          dateRange: {
            start: '2024-01-01T00:00:00Z',
            end: '2024-12-31T23:59:59Z'
          }
        }
      }
    );
    ```
    
    ---
    
    #### `importBookmarks()`
    
    Imports bookmark data with validation and duplicate handling.
    
    ```typescript
    private async importBookmarks(
      bookmarks: BookmarkData[],
      options: ImportOptions
    ): Promise<ImportResult>
    ```
    
    **Import Options Interface:**
    ```typescript
    interface ImportOptions {
      duplicateHandling: 'skip' | 'replace' | 'merge';
      validateData: boolean;
      preserveIds: boolean;
    }
    ```
    
    **Example Usage:**
    ```typescript
    const importResult = await bookmarkManager.importBookmarks(
      importedBookmarks,
      {
        duplicateHandling: 'merge',
        validateData: true,
        preserveIds: false
      }
    );
    ```
    
    **Import Result Interface:**
    ```typescript
    interface ImportResult {
      success: boolean;
      importedCount: number;
      skippedCount: number;
      errorCount: number;
      errors?: string[];
      duplicates?: number;
    }
    ```
  </Tab>
  
  <Tab value="Search & Filter">
    ### Search and Filtering Operations
    
    #### `getBookmarks()`
    
    Retrieves bookmarks with optional file path filtering and memoization.
    
    ```typescript
    getBookmarks(filePath?: string): BookmarkData[]
    ```
    
    **Example Usage:**
    ```typescript
    // Get all bookmarks
    const allBookmarks = bookmarkManager.getBookmarks();
    
    // Get bookmarks for specific file
    const movieBookmarks = bookmarkManager.getBookmarks('/Movies/Inception.mp4');
    ```
    
    **Behavior:**
    - **Memoization**: Results cached for 50ms to improve performance
    - **Filtering**: Optional file path filtering
    - **Sorting**: Returns bookmarks in configured sort order
    - **Performance**: O(1) for cached results, O(n) for uncached
    
    ---
    
    #### `searchBookmarks()`
    
    Performs full-text search across bookmark properties.
    
    ```typescript
    searchBookmarks(query: string): BookmarkData[]
    ```
    
    **Example Usage:**
    ```typescript
    // Search by title
    const dreamScenes = bookmarkManager.searchBookmarks("dream");
    
    // Search by description
    const actionScenes = bookmarkManager.searchBookmarks("fight");
    
    // Search by tags
    const favorites = bookmarkManager.searchBookmarks("favorite");
    ```
    
    **Search Behavior:**
    - **Multi-field search**: Searches title, description, and tags
    - **Case-insensitive**: Automatic case normalization
    - **Partial matching**: Supports substring matching
    - **Ranking**: Results ordered by relevance
    
    ---
    
    #### `filterByTags()`
    
    Filters bookmarks by tag criteria with AND/OR logic.
    
    ```typescript
    filterByTags(tags: string[], mode: 'AND' | 'OR' = 'OR'): BookmarkData[]
    ```
    
    **Example Usage:**
    ```typescript
    // Bookmarks with ANY of these tags
    const sciFiOrAction = bookmarkManager.filterByTags(['sci-fi', 'action'], 'OR');
    
    // Bookmarks with ALL of these tags
    const favoriteSciFi = bookmarkManager.filterByTags(['favorite', 'sci-fi'], 'AND');
    ```
  </Tab>
  
  <Tab value="Performance">
    ### Performance Optimization Methods
    
    #### Cache Management
    
    ```typescript
    private cache: BookmarkCache;
    
    // Cache operations
    private refreshCache(): void;
    private invalidateCache(): void;
    private getCacheStats(): CacheStats;
    ```
    
    **Cache Features:**
    - **Indexed lookup**: O(1) bookmark retrieval by ID
    - **LRU eviction**: Least recently used items removed first
    - **Memory limits**: Configurable cache size limits
    - **Statistics**: Performance monitoring and optimization
    
    ---
    
    #### Debounced Operations
    
    ```typescript
    private debouncedSave: (...args: any[]) => void;
    private debouncedRefreshUIs: (...args: any[]) => void;
    
    // Configuration
    const SAVE_DEBOUNCE_MS = 500;
    const UI_REFRESH_DEBOUNCE_MS = 200;
    ```
    
    **Debouncing Benefits:**
    - **Reduced I/O**: Prevents excessive file system operations
    - **UI responsiveness**: Batches UI updates for smooth experience
    - **Performance**: Significant improvement during rapid operations
    - **Battery life**: Reduces CPU usage on mobile devices
    
    ---
    
    #### Memoization
    
    ```typescript
    private memoizedGetBookmarks: (filePath?: string) => BookmarkData[];
    
    // Memoization configuration
    const MEMOIZATION_TIMEOUT_MS = 50;
    ```
    
    **Memoization Features:**
    - **Function caching**: Results cached based on parameters
    - **Time-based invalidation**: Cache expires after timeout
    - **Memory efficient**: Automatic cleanup of old cache entries
    - **Performance gains**: 10-100x improvement for repeated calls
  </Tab>
</Tabs>

## ðŸ”§ Configuration & Lifecycle

### Constructor & Initialization

```typescript
constructor(dependencies?: IINADependencies) {
  // Dependency injection with fallbacks
  this.deps = dependencies || defaultDependencies;
  
  // Initialize performance components
  this.cache = new BookmarkCache();
  this.debouncedSave = PerformanceUtils.debounce(() => this.saveBookmarks(), 500);
  this.debouncedRefreshUIs = PerformanceUtils.debounce(
    (specificUI?: 'sidebar' | 'overlay' | 'window') => this.refreshUIs(specificUI), 
    200
  );
  this.memoizedGetBookmarks = PerformanceUtils.memoize(
    (filePath?: string) => this.getBookmarksInternal(filePath), 
    50
  );
  
  // Initialize metadata detector
  this.metadataDetector = new MetadataDetector(/* ... */);
  
  // Setup system integration
  this.loadBookmarks();
  this.setupEventListeners();
  this.setupWebUI();
  this.setupUIMessageListeners();
}
```

### Event Handling

The BookmarkManager integrates with IINA's event system:

```typescript
private setupEventListeners(): void {
  this.deps.event.on("file-loaded", () => {
    this.metadataDetector.refreshMetadata()
      .then(() => this.refreshUIs())
      .catch(error => this.deps.console.error(`Metadata refresh failed: ${error.message}`));
  });
  
  // Menu integration
  this.deps.menu.addItem(
    this.deps.menu.item("Add Bookmark at Current Time", () => {
      this.addBookmark().catch(error => 
        this.deps.console.error(`Menu bookmark creation failed: ${error.message}`)
      );
    })
  );
  
  // Additional menu items for export, import, management...
}
```

## ðŸŽ¯ Usage Examples

<Tabs items={['Basic Usage', 'Advanced Workflows', 'Error Handling', 'Performance Tips']}>
  <Tab value="Basic Usage">
    ### Common Operations
    
    ```typescript
    // Initialize the bookmark manager
    const bookmarkManager = new BookmarkManager({
      console: iina.console,
      preferences: iina.preferences,
      core: iina.core,
      // ... other dependencies
    });
    
    // Create a bookmark at current position
    await bookmarkManager.addBookmark();
    
    // Create a bookmark with custom details
    await bookmarkManager.addBookmark(
      "Important Scene",
      1234.5,
      "This scene explains the main plot twist",
      ["plot", "important", "twist"]
    );
    
    // Get all bookmarks for current media
    const bookmarks = bookmarkManager.getBookmarks();
    
    // Search for specific content
    const searchResults = bookmarkManager.searchBookmarks("action scene");
    
    // Jump to a specific bookmark
    bookmarkManager.jumpToBookmark("bookmark_id_here");
    
    // Update bookmark details
    bookmarkManager.updateBookmark("bookmark_id", {
      title: "Updated Title",
      tags: ["updated", "enhanced"]
    });
    
    // Remove a bookmark
    bookmarkManager.removeBookmark("bookmark_id");
    ```
  </Tab>
  
  <Tab value="Advanced Workflows">
    ### Complex Operations
    
    ```typescript
    // Batch bookmark creation from chapters
    const mediaChapters = await getMediaChapters();
    for (const chapter of mediaChapters) {
      await bookmarkManager.addBookmark(
        chapter.title,
        chapter.startTime,
        `Chapter: ${chapter.description}`,
        ["chapter", "auto-generated"]
      );
    }
    
    // Export filtered bookmarks
    const favoriteBookmarks = bookmarkManager.getBookmarks()
      .filter(b => b.tags?.includes("favorite"));
    
    const exportResult = await bookmarkManager.exportBookmarks(favoriteBookmarks, {
      format: 'json',
      includeMetadata: true,
      filePath: '/exports/favorites.json'
    });
    
    // Import with custom handling
    const importData = JSON.parse(await readFile('/imports/bookmarks.json'));
    const importResult = await bookmarkManager.importBookmarks(importData.bookmarks, {
      duplicateHandling: 'merge',
      validateData: true,
      preserveIds: false
    });
    
    console.log(`Import completed: ${importResult.importedCount} bookmarks added`);
    ```
  </Tab>
  
  <Tab value="Error Handling">
    ### Error Management
    
    ```typescript
    try {
      await bookmarkManager.addBookmark("Test Bookmark", -100); // Invalid timestamp
    } catch (error) {
      if (error instanceof ValidationError) {
        console.error("Validation failed:", error.details);
      } else {
        console.error("Unexpected error:", error.message);
      }
    }
    
    // Handle export failures
    const exportResult = await bookmarkManager.exportBookmarks(bookmarks, options);
    if (!exportResult.success) {
      console.error("Export failed:", exportResult.error);
      // Implement retry logic or user notification
    }
    
    // Handle import with error recovery
    const importResult = await bookmarkManager.importBookmarks(data, options);
    if (importResult.errorCount > 0) {
      console.warn(`Import completed with ${importResult.errorCount} errors:`);
      importResult.errors?.forEach(error => console.warn("- " + error));
    }
    ```
  </Tab>
  
  <Tab value="Performance Tips">
    ### Optimization Strategies
    
    ```typescript
    // Use batch operations for multiple bookmarks
    const bookmarksToAdd = [...]; // Array of bookmark data
    
    // Instead of individual adds (slow):
    // for (const data of bookmarksToAdd) {
    //   await bookmarkManager.addBookmark(...);
    // }
    
    // Use batch import (fast):
    await bookmarkManager.importBookmarks(bookmarksToAdd, {
      duplicateHandling: 'skip',
      validateData: true,
      preserveIds: false
    });
    
    // Leverage memoization for repeated queries
    const filePath = '/path/to/movie.mp4';
    
    // First call: computed and cached
    const bookmarks1 = bookmarkManager.getBookmarks(filePath);
    
    // Subsequent calls within 50ms: returned from cache
    const bookmarks2 = bookmarkManager.getBookmarks(filePath); // Fast!
    
    // Use debounced operations for rapid changes
    // Multiple rapid calls will be batched automatically:
    bookmarkManager.updateBookmark(id1, {title: "New Title 1"});
    bookmarkManager.updateBookmark(id2, {title: "New Title 2"});
    bookmarkManager.updateBookmark(id3, {title: "New Title 3"});
    // Only one save operation will occur after 500ms debounce
    ```
  </Tab>
</Tabs>

<Callout type="tip" title="Best Practices">
  - **Use batch operations** for multiple bookmark changes
  - **Leverage caching** by grouping related operations
  - **Handle errors gracefully** with appropriate fallbacks
  - **Monitor performance** using built-in cache statistics
  - **Test thoroughly** with edge cases and large datasets
</Callout>